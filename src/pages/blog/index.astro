---
// ========================================
// BLOG LIST PAGE
// Clean, modern blog page with featured article
// Category filters, featured card, article grid
// ========================================

import Layout from '../../layouts/Layout.astro'
import ArticleGrid from '../../components/blog/layouts/ArticleGrid.astro'
import FeaturedBlogCard from '../../components/blog/cards/FeaturedBlogCard.astro'
import BlogArticleCard from '../../components/blog/cards/BlogArticleCard.astro'
import { getBlogArticles } from '../../lib/api'
import { fetchBrandSettings } from '../../lib/brand'

// Fetch brand settings
const brand = await fetchBrandSettings()

// Get pagination and category filter from URL
const url = new URL(Astro.request.url)
const currentPage = parseInt(url.searchParams.get('page') || '1')
const selectedCategory = url.searchParams.get('category') || ''
const limit = 12

// Fetch blog articles
const blogResponse = await getBlogArticles({ page: currentPage, limit })
const allArticles = blogResponse?.articles || []
const totalArticles = blogResponse?.total || 0
const hasMore = blogResponse?.hasMore || false

// Extract unique categories from articles
const categoriesMap = new Map<string, string>()
allArticles.forEach(article => {
  article.categories?.forEach(cat => {
    if (cat.name && !categoriesMap.has(cat.name)) {
      categoriesMap.set(cat.name, cat.category_id || cat.name)
    }
  })
})
const categories = Array.from(categoriesMap.entries()).map(([name, id]) => ({ name, id }))

// Filter articles by category if selected
const filteredArticles = selectedCategory
  ? allArticles.filter(a => a.categories?.some(c => c.name === selectedCategory))
  : allArticles

// Separate featured and regular articles (only on first page without category filter)
const featuredArticle = currentPage === 1 && !selectedCategory
  ? filteredArticles.find(a => a.is_featured) || filteredArticles[0]
  : null

const regularArticles = featuredArticle
  ? filteredArticles.filter(a => a.article_id !== featuredArticle.article_id)
  : filteredArticles

// Calculate pagination
const totalPages = Math.ceil(totalArticles / limit)

const pageTitle = `Blog | ${brand.business_name}`
const pageDescription = `Read the latest property news, market insights, and helpful guides from ${brand.business_name}.`
---

<Layout title={pageTitle} description={pageDescription} headerVariant="solid">
  <div class="blog-page">

    <!-- Page Header -->
    <header class="blog-header">
      <h1 class="blog-header__title">Blog & articles</h1>

      <!-- Category Filters -->
      {categories.length > 0 && (
        <nav class="blog-filters" aria-label="Filter by category">
          <a
            href="/blog"
            class:list={['blog-filters__btn', { 'blog-filters__btn--active': !selectedCategory }]}
          >
            All
          </a>
          {categories.map(cat => (
            <a
              href={`/blog?category=${encodeURIComponent(cat.name)}`}
              class:list={['blog-filters__btn', { 'blog-filters__btn--active': selectedCategory === cat.name }]}
            >
              {cat.name}
            </a>
          ))}
        </nav>
      )}
    </header>

    <!-- Featured Article -->
    {featuredArticle && (
      <section class="blog-featured">
        <FeaturedBlogCard article={featuredArticle} />
      </section>
    )}

    <!-- All Articles Section -->
    <section class="blog-section">
      <!-- Section Header -->
      <div class="blog-section__header">
        <span class="blog-section__bullet"></span>
        <span class="blog-section__label">Blog and articles</span>
        <h2 class="blog-section__title">Latest insights and trends</h2>
        <span class="blog-section__count">
          {regularArticles.length}&nbsp;{regularArticles.length === 1 ? 'article' : 'articles'}
        </span>
      </div>

      <!-- Article Grid -->
      <ArticleGrid
        articles={regularArticles}
        configId="listing"
        emptyMessage="No articles yet. Check back soon for our latest property insights and guides."
      />

      <!-- Pagination -->
      {totalPages > 1 && (
        <nav class="pagination" aria-label="Blog pagination">
          {currentPage > 1 && (
            <a href={`/blog?page=${currentPage - 1}${selectedCategory ? `&category=${encodeURIComponent(selectedCategory)}` : ''}`} class="pagination__btn pagination__btn--prev">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Previous
            </a>
          )}

          <div class="pagination__numbers">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
              <a
                href={`/blog?page=${page}${selectedCategory ? `&category=${encodeURIComponent(selectedCategory)}` : ''}`}
                class:list={['pagination__number', { 'pagination__number--active': page === currentPage }]}
                aria-current={page === currentPage ? 'page' : undefined}
              >
                {page}
              </a>
            ))}
          </div>

          {hasMore && (
            <a href={`/blog?page=${currentPage + 1}${selectedCategory ? `&category=${encodeURIComponent(selectedCategory)}` : ''}`} class="pagination__btn pagination__btn--next">
              Next
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
          )}
        </nav>
      )}
    </section>

  </div>
</Layout>

<style lang="scss">
  @use '../../styles/pages/blog/list';
</style>
