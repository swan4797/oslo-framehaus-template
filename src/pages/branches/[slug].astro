---
// ========================================
// BRANCH MICROSITE PAGE - DYNAMIC CONTENT
// Fetches content from Stratos CRM Branch Microsites feature
// ========================================

import Layout from '../../layouts/Layout.astro'
import DetailHero from '../../components/details/DetailHero.astro'
import DetailContent from '../../components/details/DetailContent.astro'
import DetailStats from '../../components/details/DetailStats.astro'
import DetailCta from '../../components/details/DetailCta.astro'
import PropertyGrid from '../../components/properties/grids/PropertyGrid.astro'
import BranchTeamSection from '../../components/branches/details/BranchTeamSection.astro'
import BranchContactSection from '../../components/branches/details/BranchContactSection.astro'

// Microsite utilities
import {
  getBranchMicrosite,
  getAllBranchMicrosites,
  getAllSections,
  getSectionTitle,
  getSectionContent,
  getSectionImage,
  hasSection,
  hasHeroImage,
  getHeroImage,
  hasTeamMembers,
  getTeamMembers,
  getBranchContact,
  type ContentBlock as ContentBlockType,
  type BranchMicrosite,
} from '../../lib/microsites'

// Generate static paths for all published microsites
export async function getStaticPaths() {
  const microsites = await getAllBranchMicrosites()

  return microsites.map((microsite) => ({
    params: { slug: microsite.page_slug },
    props: { microsite },
  }))
}

// Get props
interface Props {
  microsite?: BranchMicrosite
}

const { slug } = Astro.params
const { microsite: preloadedMicrosite } = Astro.props as Props

// Use preloaded microsite or fetch fresh
const microsite = preloadedMicrosite || await getBranchMicrosite(slug as string)

// Handle 404
if (!microsite) {
  return Astro.redirect('/404')
}

// Extract hero data
const heroTitle = microsite.display_name || microsite.branch_name
const heroSubtitle = microsite.description || `Your local property experts in ${microsite.branch_name}`
const heroImage = hasHeroImage(microsite) ? getHeroImage(microsite) : null

// Get all content sections
const allSections = getAllSections(microsite)

// Known section keys (handled separately)
const knownBlockKeys = ['welcome', 'services', 'area_guide', 'contact']
const additionalSections = allSections.filter(s => !knownBlockKeys.includes(s.block_key))

// Team members
const teamMembers = getTeamMembers(microsite)
const showTeam = hasTeamMembers(microsite)

// Contact info
const contact = getBranchContact(microsite)

// Properties filter from microsite settings
const propertiesFilter = microsite.properties_filter || {}
const showSalesProperties = !propertiesFilter.listing_type || propertiesFilter.listing_type === 'sale' || propertiesFilter.listing_type === 'both'
const showRentalProperties = !propertiesFilter.listing_type || propertiesFilter.listing_type === 'rent' || propertiesFilter.listing_type === 'both'
const propertyLimit = propertiesFilter.limit || 6

// Page meta
const pageTitle = `${heroTitle} | Estate Agents`
const pageDescription = microsite.description || `Property services in ${microsite.branch_name}. Sales, lettings, valuations and more.`

// Build content blocks for DetailContent component
const contentBlocks = [
  hasSection(microsite, 'welcome') ? {
    title: getSectionTitle(microsite, 'welcome', `Welcome to ${microsite.branch_name}`),
    description: getSectionContent(microsite, 'welcome') || ''
  } : null,
  hasSection(microsite, 'services') ? {
    title: getSectionTitle(microsite, 'services', 'Our Services'),
    description: getSectionContent(microsite, 'services') || ''
  } : null,
  hasSection(microsite, 'area_guide') ? {
    title: getSectionTitle(microsite, 'area_guide', 'Area Guide'),
    description: getSectionContent(microsite, 'area_guide') || ''
  } : null,
  hasSection(microsite, 'contact') ? {
    title: getSectionTitle(microsite, 'contact', 'Contact Us'),
    description: getSectionContent(microsite, 'contact') || ''
  } : null,
  ...additionalSections.map((block: ContentBlockType) => ({
    title: block.section?.title || block.block_key.replace(/_/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase()),
    description: block.section?.content || ''
  }))
].filter(block => block && block.description) as Array<{ title: string; description: string }>

// Get section image for DetailContent
const welcomeImage = getSectionImage(microsite, 'welcome')?.url
const servicesImage = getSectionImage(microsite, 'services')?.url
const contentImage = welcomeImage || servicesImage || heroImage?.url

// Build stats
const branchStats = [
  { label: 'Properties For Sale', value: propertyLimit + '+' },
  { label: 'Rental Properties', value: propertyLimit + '+' },
  showTeam && teamMembers.length > 0 ? { label: 'Expert Team Members', value: String(teamMembers.length) } : null,
  { label: 'Years Experience', value: '10+' }
].filter(Boolean) as Array<{ label: string; value: string }>

// Debug logging
console.log('[Branch Page] Rendering:', microsite.page_slug)
console.log('[Branch Page] Sections:', allSections.length)
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Hero Section -->
  <DetailHero
    label="Our Branch"
    title={heroTitle}
    titleEmphasis="Your Local Experts"
    description={heroSubtitle}
    ctaText="View Properties"
    ctaLink={`/properties?branch=${microsite.branch_id}`}
    imageSrc={heroImage?.url || "https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=1920&q=80"}
    imageAlt={`${microsite.branch_name} office`}
  />

  <!-- Content Section -->
  {contentBlocks.length > 0 && (
    <DetailContent
      title={`About ${microsite.branch_name}`}
      titleEmphasis="Estate Agents"
      imageSrc={contentImage || "https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=1200&q=80"}
      imageAlt={`${microsite.branch_name} team`}
      blocks={contentBlocks.slice(0, 4)}
    />
  )}

  <!-- Stats Section -->
  {branchStats.length > 0 && (
    <DetailStats
      title="Essential Aspects"
      titleEmphasis="Driving Our Success"
      description={`Our success in ${microsite.branch_name} is driven by innovation, operational excellence, and a strong commitment to our clients.`}
      stats={branchStats}
    />
  )}

  <!-- Properties For Sale -->
  {showSalesProperties && (
    <PropertyGrid
      title={`Properties For Sale in ${microsite.branch_name}`}
      subtitle="Browse our latest properties available for sale"
      branchId={microsite.branch_id}
      listingType="sale"
      listingStatus="available"
      limit={propertyLimit}
      sortBy="newest"
      columns={4}
      ctaText="View All Sales"
      ctaLink={`/search?listing_type=sale&branch=${microsite.branch_id}`}
      variant="default"
    />
  )}

  <!-- Properties To Let -->
  {showRentalProperties && (
    <PropertyGrid
      title={`Properties To Let in ${microsite.branch_name}`}
      subtitle="Browse our latest rental properties"
      branchId={microsite.branch_id}
      listingType="let"
      listingStatus="available"
      limit={propertyLimit}
      sortBy="newest"
      columns={4}
      ctaText="View All Rentals"
      ctaLink={`/search?listing_type=let&branch=${microsite.branch_id}`}
      variant="alt"
    />
  )}

  <!-- Team Section -->
  {showTeam && (
    <BranchTeamSection
      branchName={microsite.branch_name}
      teamMembers={teamMembers}
    />
  )}

  <!-- Branch Contact Info -->
  <BranchContactSection
    branchName={microsite.branch_name}
    contact={contact}
  />

  <!-- CTA Banner -->
  <DetailCta
    title={`Ready to start your property journey in ${microsite.branch_name}?`}
    subtitle="Whether you're buying, selling, or renting, our local team is here to help."
    primaryCtaText="Contact Us"
    primaryCtaLink="/contact"
    secondaryCtaText="Free Valuation"
    secondaryCtaLink="/valuation"
  />
</Layout>
