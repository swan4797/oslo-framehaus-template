---
// ========================================
// SEARCH BAR CORE (Headless Component)
// Pure logic - no styling, no UI
// Handles: state, URL params, form submission, tracking
// ========================================
//
// USAGE:
// This is a headless component. Use it as a base for building
// custom search UIs while getting consistent form handling,
// URL params, and tracking for free.
//
// Example:
// <SearchBarCore config={myConfig}>
//   <MyCustomSearchUI />
// </SearchBarCore>
//
// ========================================

import type { PropertySearchParams } from '../../types/database'

// Export type for child components
export interface SearchBarConfig {
  // Which fields to include
  fields: {
    listingType?: boolean
    location?: boolean
    minPrice?: boolean
    maxPrice?: boolean
    bedrooms?: boolean
    bathrooms?: boolean
    propertyType?: boolean
    epcRating?: boolean
    councilTaxBand?: boolean
    parking?: boolean
    tenure?: boolean
    minLeaseYears?: boolean
    maxServiceCharge?: boolean
    minArea?: boolean
    maxArea?: boolean
    garden?: boolean
    newBuild?: boolean
    furnishing?: boolean
    // ... all other fields
  }
  
  // Behavior
  redirectUrl?: string
  currentParams?: PropertySearchParams
  
  // Customization
  placeholders?: {
    location?: string
    minPrice?: string
    maxPrice?: string
    // ... etc
  }
  
  // Callbacks
  onSubmit?: (params: PropertySearchParams) => void
  onChange?: (field: string, value: any) => void
}

interface Props {
  config: SearchBarConfig
  children: any
}

const { config, children } = Astro.props

// Generate field data that child components can use
const fieldData = {
  listingType: config.fields.listingType ? {
    name: 'listing_type',
    value: config.currentParams?.listing_type || 'sale',
    options: [
      { value: 'sale', label: 'Buy' },
      { value: 'let', label: 'Rent' },
    ]
  } : null,
  
  location: config.fields.location ? {
    name: 'location',
    value: config.currentParams?.location || '',
    placeholder: config.placeholders?.location || 'Location or postcode',
  } : null,
  
  // Sales prices: £100,000 to £2,000,000 in £100,000 increments
  // Lettings prices: £500 to £5,000 in £500 increments
  minPrice: config.fields.minPrice ? {
    name: 'min_price',
    value: config.currentParams?.min_price || '',
    options: config.currentParams?.listing_type === 'let' ? [
      { value: '', label: 'Min Rent' },
      { value: '500', label: '£500 pcm' },
      { value: '1000', label: '£1,000 pcm' },
      { value: '1500', label: '£1,500 pcm' },
      { value: '2000', label: '£2,000 pcm' },
      { value: '2500', label: '£2,500 pcm' },
      { value: '3000', label: '£3,000 pcm' },
      { value: '3500', label: '£3,500 pcm' },
      { value: '4000', label: '£4,000 pcm' },
      { value: '4500', label: '£4,500 pcm' },
      { value: '5000', label: '£5,000 pcm' },
    ] : [
      { value: '', label: 'Min Price' },
      { value: '100000', label: '£100,000' },
      { value: '200000', label: '£200,000' },
      { value: '300000', label: '£300,000' },
      { value: '400000', label: '£400,000' },
      { value: '500000', label: '£500,000' },
      { value: '600000', label: '£600,000' },
      { value: '700000', label: '£700,000' },
      { value: '800000', label: '£800,000' },
      { value: '900000', label: '£900,000' },
      { value: '1000000', label: '£1,000,000' },
      { value: '1100000', label: '£1,100,000' },
      { value: '1200000', label: '£1,200,000' },
      { value: '1300000', label: '£1,300,000' },
      { value: '1400000', label: '£1,400,000' },
      { value: '1500000', label: '£1,500,000' },
      { value: '1600000', label: '£1,600,000' },
      { value: '1700000', label: '£1,700,000' },
      { value: '1800000', label: '£1,800,000' },
      { value: '1900000', label: '£1,900,000' },
      { value: '2000000', label: '£2,000,000' },
    ]
  } : null,

  maxPrice: config.fields.maxPrice ? {
    name: 'max_price',
    value: config.currentParams?.max_price || '',
    options: config.currentParams?.listing_type === 'let' ? [
      { value: '', label: 'Max Rent' },
      { value: '500', label: '£500 pcm' },
      { value: '1000', label: '£1,000 pcm' },
      { value: '1500', label: '£1,500 pcm' },
      { value: '2000', label: '£2,000 pcm' },
      { value: '2500', label: '£2,500 pcm' },
      { value: '3000', label: '£3,000 pcm' },
      { value: '3500', label: '£3,500 pcm' },
      { value: '4000', label: '£4,000 pcm' },
      { value: '4500', label: '£4,500 pcm' },
      { value: '5000', label: '£5,000 pcm' },
    ] : [
      { value: '', label: 'Max Price' },
      { value: '100000', label: '£100,000' },
      { value: '200000', label: '£200,000' },
      { value: '300000', label: '£300,000' },
      { value: '400000', label: '£400,000' },
      { value: '500000', label: '£500,000' },
      { value: '600000', label: '£600,000' },
      { value: '700000', label: '£700,000' },
      { value: '800000', label: '£800,000' },
      { value: '900000', label: '£900,000' },
      { value: '1000000', label: '£1,000,000' },
      { value: '1100000', label: '£1,100,000' },
      { value: '1200000', label: '£1,200,000' },
      { value: '1300000', label: '£1,300,000' },
      { value: '1400000', label: '£1,400,000' },
      { value: '1500000', label: '£1,500,000' },
      { value: '1600000', label: '£1,600,000' },
      { value: '1700000', label: '£1,700,000' },
      { value: '1800000', label: '£1,800,000' },
      { value: '1900000', label: '£1,900,000' },
      { value: '2000000', label: '£2,000,000' },
    ]
  } : null,
  
  bedrooms: config.fields.bedrooms ? {
    name: 'beds',
    value: config.currentParams?.beds || '',
    options: [
      { value: '', label: 'Beds' },
      { value: '1', label: '1+' },
      { value: '2', label: '2+' },
      { value: '3', label: '3+' },
      { value: '4', label: '4+' },
      { value: '5', label: '5+' },
    ]
  } : null,
  
  propertyType: config.fields.propertyType ? {
    name: 'property_type',
    value: config.currentParams?.property_type || '',
    options: [
      { value: '', label: 'All Types' },
      { value: 'detached', label: 'Detached' },
      { value: 'semi-detached', label: 'Semi-Detached' },
      { value: 'terraced', label: 'Terraced' },
      { value: 'flat', label: 'Flat' },
      { value: 'bungalow', label: 'Bungalow' },
    ]
  } : null,
  
  // Add more fields as needed...
}

// Pass field data to children via slot props
const props = {
  fields: fieldData,
  config: config,
  redirectUrl: config.redirectUrl || '/search',
}
---

<div class="search-bar-core" data-config={JSON.stringify(config)}>
  <slot {...props} />
</div>

<script>
  import { storeSearchForTracking } from '../../lib/search-tracker'

  // Default values to exclude from URL
  const SEARCH_DEFAULTS: Record<string, string> = {
    listing_type: 'sale',
    page: '1',
    limit: '20',
    sort_by: 'newest',
  }

  // Check if a param should be excluded from the URL
  function shouldExcludeParam(key: string, value: string): boolean {
    // Exclude empty values
    if (!value || value === 'false') return true

    // Exclude default values
    if (key in SEARCH_DEFAULTS && SEARCH_DEFAULTS[key] === value) return true

    return false
  }

  // Core search logic - works with any UI
  document.addEventListener('DOMContentLoaded', () => {
    const searchForms = document.querySelectorAll('[data-search-form]')

    searchForms.forEach(form => {
      const formElement = form as HTMLFormElement
      const configElement = form.closest('.search-bar-core') as HTMLElement
      const config = JSON.parse(configElement?.dataset.config || '{}')

      // Handle form submission
      formElement.addEventListener('submit', (e) => {
        e.preventDefault()

        const formData = new FormData(formElement)
        const urlParams = new URLSearchParams()
        const searchParams: Record<string, any> = {}

        // Clean URL - only include non-default, non-empty params
        formData.forEach((value, key) => {
          const stringValue = value.toString().trim()
          searchParams[key] = stringValue

          if (!shouldExcludeParam(key, stringValue)) {
            urlParams.append(key, stringValue)
          }
        })

        // Build navigation URL
        const redirectUrl = config.redirectUrl || '/search'
        const queryString = urlParams.toString()
        const targetUrl = queryString ? `${redirectUrl}?${queryString}` : redirectUrl

        // Store search data for tracking (will be sent on search results page load)
        // This is 100% reliable - no race conditions with navigation
        storeSearchForTracking({
          listing_type: searchParams.listing_type || 'sale',
          location: searchParams.location || searchParams.q || '',
          postcode: searchParams.postcode || '',
          min_price: searchParams.min_price,
          max_price: searchParams.max_price,
          bedrooms: searchParams.beds || searchParams.bedrooms,
          bathrooms: searchParams.min_baths || searchParams.bathrooms,
          property_type: searchParams.property_type,
          filters: searchParams,
          filters_count: Object.keys(searchParams).filter(k => !shouldExcludeParam(k, searchParams[k])).length,
          source_page: window.location.pathname,
          source_component: 'search_bar_core',
        })

        console.log('[SearchBarCore] Search stored, navigating to:', targetUrl)

        // Navigate to search results
        window.location.href = targetUrl
      })
    })
  })
</script>