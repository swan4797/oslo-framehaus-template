---
// ========================================
// CONTENT BLOCK COMPONENT
// Editorial-style 50/50 split layout
// Supports image/video with reversible positioning
// Integrates with Stratos CRM via blockKey
// ========================================

import type { PageContent } from '../../../lib/pages'
import { getSectionTitle, getSectionContent, getSectionImage } from '../../../lib/pages'

type MediaType = 'image' | 'video'
type ImagePosition = 'left' | 'right'
type OverlayStrength = 'none' | 'light' | 'medium' | 'dark'
type LayoutVariant = 'default' | 'faq'

interface FaqItem {
  question: string
  answer: string
}

interface Props {
  // CMS Integration
  blockKey?: string
  pageContent?: PageContent | null

  // Media (fallback if no CMS content)
  mediaType?: MediaType
  mediaSrc?: string
  mediaAlt?: string
  mediaPoster?: string

  // Secondary Media (for stacked/overlapping layout)
  secondaryMediaSrc?: string
  secondaryMediaAlt?: string

  // Content (fallback if no CMS content)
  title?: string
  subtitle?: string
  description?: string
  ctaText?: string
  ctaLink?: string

  // Service list items (displayed at bottom of text)
  serviceItems?: string[]

  // FAQ items (for FAQ layout variant)
  faqItems?: FaqItem[]

  // Layout
  layout?: LayoutVariant
  imagePosition?: ImagePosition
  overlayStrength?: OverlayStrength

  // Styling
  textBackground?: string
  accentColor?: string
}

const {
  // CMS props
  blockKey = '',
  pageContent = null,
  // Media props
  mediaType = 'image',
  mediaSrc = '',
  mediaAlt = '',
  mediaPoster = '',
  // Secondary media props
  secondaryMediaSrc = '',
  secondaryMediaAlt = '',
  // Content props
  title = '',
  subtitle = '',
  description = '',
  ctaText = '',
  ctaLink = '',
  // Service list
  serviceItems = [],
  // FAQ items
  faqItems = [],
  // Layout props
  layout = 'default',
  imagePosition = 'left',
  overlayStrength = 'none',
  // Styling props
  textBackground = '#ffffff',
  accentColor = '',
} = Astro.props

// Check for dual images layout
const hasDualImages = !!secondaryMediaSrc

// ========================================
// CMS CONTENT RESOLUTION
// If blockKey is provided, fetch from Stratos CMS
// Otherwise, use static props as fallback
// ========================================

const cmsTitle = blockKey && pageContent ? getSectionTitle(pageContent, blockKey, title) : title
const cmsContent = blockKey && pageContent ? getSectionContent(pageContent, blockKey, description) : description
const cmsImage = blockKey && pageContent ? getSectionImage(pageContent, blockKey) : null

// Resolve final values (CMS takes priority)
const finalMediaSrc = cmsImage?.url || mediaSrc
const finalMediaAlt = cmsImage?.alt || mediaAlt
const finalTitle = cmsTitle || title
const finalDescription = cmsContent || description

const sectionClasses = [
  'content-block',
  `content-block--media-${imagePosition}`,
  `content-block--${layout}`,
  hasDualImages && 'content-block--dual-images',
].filter(Boolean).join(' ')

// Check if FAQ layout with items
const isFaqLayout = layout === 'faq' && faqItems.length > 0
---

<section class={sectionClasses}>
  <!-- Media Column -->
  {finalMediaSrc && (
    <div class="content-block__media">
      {hasDualImages ? (
        <!-- Dual Images Layout -->
        <div class="content-block__dual-images">
          <div class="content-block__image-primary">
            <img src={finalMediaSrc} alt={finalMediaAlt} loading="lazy" />
          </div>
          <div class="content-block__image-secondary">
            <img src={secondaryMediaSrc} alt={secondaryMediaAlt} loading="lazy" />
          </div>
        </div>
      ) : mediaType === 'video' ? (
        <video
          class="content-block__video"
          autoplay
          muted
          loop
          playsinline
          poster={mediaPoster}
        >
          <source src={finalMediaSrc} type="video/mp4" />
        </video>
      ) : (
        <div
          class="content-block__image"
          style={`background-image: url('${finalMediaSrc}')`}
          role="img"
          aria-label={finalMediaAlt}
        />
      )}
      {overlayStrength !== 'none' && !hasDualImages && (
        <div class={`content-block__overlay content-block__overlay--${overlayStrength}`}></div>
      )}
    </div>
  )}

  <!-- Text Column -->
  <div class="content-block__text" style={`background-color: ${textBackground}`}>
    <div class="content-block__text-inner">
      {/* FAQ Layout */}
      {isFaqLayout ? (
        <>
          {subtitle && (
            <div class="content-block__label-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="7" height="7" rx="1" />
                <rect x="14" y="3" width="7" height="7" rx="1" />
                <rect x="3" y="14" width="7" height="7" rx="1" />
                <rect x="14" y="14" width="7" height="7" rx="1" />
              </svg>
              <span>{subtitle}</span>
            </div>
          )}

          {finalTitle && (
            <h2 class="content-block__title content-block__title--faq" set:html={finalTitle} />
          )}

          <div class="content-block__faq-list">
            {faqItems.map((item, index) => (
              <div class="content-block__faq-item" data-faq-index={index}>
                <button
                  type="button"
                  class="content-block__faq-question"
                  aria-expanded="false"
                  aria-controls={`faq-answer-${index}`}
                >
                  <span>{item.question}</span>
                  <svg class="content-block__faq-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 5v14M5 12h14" />
                  </svg>
                </button>
                <div
                  id={`faq-answer-${index}`}
                  class="content-block__faq-answer"
                  aria-hidden="true"
                >
                  <p>{item.answer}</p>
                </div>
              </div>
            ))}
          </div>
        </>
      ) : (
        <>
          {/* Default Layout */}
          {subtitle && (
            <span class="content-block__subtitle" style={accentColor ? `color: ${accentColor}` : ''}>
              {subtitle}
            </span>
          )}

          {finalTitle && (
            <h2 class="content-block__title" set:html={finalTitle} />
          )}

          {finalDescription && (
            <div class="content-block__description" set:html={finalDescription} />
          )}

          {ctaText && ctaLink && (
            <a href={ctaLink} class="content-block__cta" style={accentColor ? `color: ${accentColor}; border-color: ${accentColor}` : ''}>
              {ctaText}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          )}

          {serviceItems && serviceItems.length > 0 && (
            <ul class="content-block__services">
              {serviceItems.map((item) => (
                <li class="content-block__service-item">{item}</li>
              ))}
            </ul>
          )}
        </>
      )}
    </div>
  </div>
</section>

<script>
  // ========================================
  // FAQ ACCORDION FUNCTIONALITY
  // ========================================

  function initFaqAccordion() {
    const faqItems = document.querySelectorAll('.content-block__faq-item')
    if (!faqItems.length) return

    faqItems.forEach((item) => {
      const questionBtn = item.querySelector('.content-block__faq-question')
      const answer = item.querySelector('.content-block__faq-answer')

      if (!questionBtn || !answer) return

      questionBtn.addEventListener('click', () => {
        const isExpanded = questionBtn.getAttribute('aria-expanded') === 'true'

        // Close all other items
        faqItems.forEach((otherItem) => {
          if (otherItem !== item) {
            const otherBtn = otherItem.querySelector('.content-block__faq-question')
            const otherAnswer = otherItem.querySelector('.content-block__faq-answer')
            if (otherBtn && otherAnswer) {
              otherBtn.setAttribute('aria-expanded', 'false')
              otherAnswer.setAttribute('aria-hidden', 'true')
              otherItem.classList.remove('content-block__faq-item--open')
            }
          }
        })

        // Toggle current item
        questionBtn.setAttribute('aria-expanded', String(!isExpanded))
        answer.setAttribute('aria-hidden', String(isExpanded))
        item.classList.toggle('content-block__faq-item--open', !isExpanded)
      })
    })
  }

  // Initialize on page load
  initFaqAccordion()

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initFaqAccordion)
</script>

<style lang="scss">
  @use '../../../styles/components/content-block';
</style>
