---
// ========================================
// TIME PICKER FIELD
// Custom time selection buttons
// ========================================

interface Props {
  name: string
  label?: string
  defaultValue?: string
  class?: string
}

const {
  name,
  label,
  defaultValue = '',
  class: className,
} = Astro.props

const timeOptions = [
  { value: '', label: 'Flexible', icon: 'clock' },
  { value: 'morning', label: 'Morning', range: '9am - 12pm', icon: 'sunrise' },
  { value: 'afternoon', label: 'Afternoon', range: '12pm - 5pm', icon: 'sun' },
  { value: 'evening', label: 'Evening', range: '5pm - 7pm', icon: 'moon' },
]
---

<div class:list={['time-picker', className]}>
  {label && (
    <span class="time-picker__label">{label}</span>
  )}

  <input type="hidden" name={name} value={defaultValue} data-time-input />

  <div class="time-picker__options" data-time-picker>
    {timeOptions.map((option) => (
      <button
        type="button"
        class:list={['time-picker__option', { 'is-selected': option.value === defaultValue }]}
        data-value={option.value}
      >
        {option.icon === 'clock' && (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
        )}
        {option.icon === 'sunrise' && (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="4" />
            <path d="M12 2v2" />
            <path d="M12 20v2" />
            <path d="m4.93 4.93 1.41 1.41" />
            <path d="m17.66 17.66 1.41 1.41" />
            <path d="M2 12h2" />
            <path d="M20 12h2" />
            <path d="m6.34 17.66-1.41 1.41" />
            <path d="m19.07 4.93-1.41 1.41" />
          </svg>
        )}
        {option.icon === 'sun' && (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="4" />
            <path d="M12 4v2" />
            <path d="M12 18v2" />
            <path d="m6.34 6.34-1.41-1.41" />
            <path d="m17.66 17.66 1.41 1.41" />
            <path d="M4 12H2" />
            <path d="M22 12h-2" />
          </svg>
        )}
        {option.icon === 'moon' && (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
          </svg>
        )}
        <span class="time-picker__option-label">{option.label}</span>
        {option.range && (
          <span class="time-picker__option-range">{option.range}</span>
        )}
      </button>
    ))}
  </div>
</div>

<style lang="scss">
  .time-picker {
    width: 100%;
  }

  .time-picker__label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-primary, #1a1a1a);
  }

  .time-picker__options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;

    @media (max-width: 640px) {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .time-picker__option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    padding: 0.875rem 0.5rem;
    background: #fafafa;
    border: 1px solid transparent;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: var(--font-family-body, system-ui, sans-serif);

    &:hover {
      background: #f5f5f5;
    }

    &.is-selected {
      background: var(--color-primary, #3c5b4b);
      border-color: var(--color-primary, #3c5b4b);
      color: #fff;

      .time-picker__option-range {
        color: rgba(255, 255, 255, 0.7);
      }
    }

    svg {
      width: 1.25rem;
      height: 1.25rem;
    }
  }

  .time-picker__option-label {
    font-size: 0.8125rem;
    font-weight: 600;
  }

  .time-picker__option-range {
    font-size: 0.6875rem;
    color: var(--color-text-muted, #8a8a8a);
  }
</style>

<script>
  function initTimePickers() {
    document.querySelectorAll('[data-time-picker]').forEach((picker) => {
      // Skip if already initialized
      if ((picker as any)._timePickerInit) return
      ;(picker as any)._timePickerInit = true

      const input = picker.parentElement?.querySelector('[data-time-input]') as HTMLInputElement
      const options = picker.querySelectorAll('.time-picker__option')

      options.forEach((option) => {
        option.addEventListener('click', () => {
          // Remove selected from all
          options.forEach((opt) => opt.classList.remove('is-selected'))

          // Add selected to clicked
          option.classList.add('is-selected')

          // Update hidden input
          if (input) {
            input.value = (option as HTMLElement).dataset.value || ''
          }
        })
      })
    })
  }

  // Initialize on initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTimePickers)
  } else {
    initTimePickers()
  }

  // Re-initialize on Astro page navigation (View Transitions)
  document.addEventListener('astro:page-load', initTimePickers)
</script>
