---
// ========================================
// COOKIE CONSENT BANNER
// GDPR-compliant cookie consent
// Modern, clean design with animations
// ========================================

import { gdprConfig } from '../lib/config'

const CONSENT_KEY = 'stratos_cookie_consent'
const CONSENT_VERSION = gdprConfig.privacyPolicyVersion
---

<!-- Cookie Consent Overlay -->
<div id="cookie-consent-overlay" class="cookie-overlay" aria-hidden="true">
  <div class="cookie-overlay__backdrop"></div>
</div>

<!-- Cookie Consent Banner -->
<div id="cookie-consent-banner" class="cookie-banner" aria-hidden="true">
  <div class="cookie-banner__container">
    <div class="cookie-banner__content">
      <!-- Icon -->
      <div class="cookie-banner__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <circle cx="8" cy="9" r="1" fill="currentColor"/>
          <circle cx="15" cy="9" r="1" fill="currentColor"/>
          <circle cx="9" cy="14" r="1" fill="currentColor"/>
          <circle cx="14" cy="13" r="1" fill="currentColor"/>
          <circle cx="12" cy="17" r="1" fill="currentColor"/>
        </svg>
      </div>

      <!-- Text -->
      <div class="cookie-banner__text">
        <h3 class="cookie-banner__title">We value your privacy</h3>
        <p class="cookie-banner__description">
          We use cookies to enhance your browsing experience and analyze site traffic.
          By clicking "Accept All", you consent to our use of cookies as described in our
          <a href={gdprConfig.cookiePolicyUrl} class="cookie-banner__link">Cookie Policy</a>.
        </p>
      </div>
    </div>

    <!-- Buttons -->
    <div class="cookie-banner__actions">
      <button id="cookie-settings-btn" class="cookie-banner__btn cookie-banner__btn--secondary">
        Customize
      </button>
      <button id="cookie-reject-btn" class="cookie-banner__btn cookie-banner__btn--secondary">
        Reject All
      </button>
      <button id="cookie-accept-btn" class="cookie-banner__btn cookie-banner__btn--primary">
        Accept All
      </button>
    </div>
  </div>
</div>

<!-- Cookie Settings Modal -->
<div id="cookie-settings-modal" class="cookie-modal" aria-hidden="true">
  <div class="cookie-modal__backdrop"></div>
  <div class="cookie-modal__dialog" role="dialog" aria-labelledby="cookie-modal-title">
    <!-- Header -->
    <div class="cookie-modal__header">
      <div class="cookie-modal__header-content">
        <div class="cookie-modal__icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 00.73 2.73l.15.1a2 2 0 011 1.72v.51a2 2 0 01-1 1.74l-.15.09a2 2 0 00-.73 2.73l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.39a2 2 0 00-.73-2.73l-.15-.08a2 2 0 01-1-1.74v-.5a2 2 0 011-1.74l.15-.09a2 2 0 00.73-2.73l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </div>
        <h2 id="cookie-modal-title" class="cookie-modal__title">Cookie Settings</h2>
      </div>
      <button id="close-settings-modal" class="cookie-modal__close" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div class="cookie-modal__content">
      <!-- Necessary Cookies -->
      <div class="cookie-modal__category">
        <div class="cookie-modal__category-header">
          <div class="cookie-modal__category-info">
            <h3 class="cookie-modal__category-title">Essential Cookies</h3>
            <span class="cookie-modal__badge cookie-modal__badge--required">Always Active</span>
          </div>
        </div>
        <p class="cookie-modal__category-desc">
          These cookies are essential for the website to function properly. They enable core
          functionality like security, network management, and accessibility.
        </p>
      </div>

      <!-- Analytics Cookies -->
      <div class="cookie-modal__category">
        <div class="cookie-modal__category-header">
          <div class="cookie-modal__category-info">
            <h3 class="cookie-modal__category-title">Analytics Cookies</h3>
          </div>
          <label class="cookie-toggle">
            <input type="checkbox" id="analytics-toggle" class="cookie-toggle__input" />
            <span class="cookie-toggle__slider"></span>
          </label>
        </div>
        <p class="cookie-modal__category-desc">
          These cookies help us understand how visitors interact with our website by collecting
          and reporting information anonymously. This helps us improve your experience.
        </p>
      </div>

      <!-- Marketing Cookies -->
      <div class="cookie-modal__category">
        <div class="cookie-modal__category-header">
          <div class="cookie-modal__category-info">
            <h3 class="cookie-modal__category-title">Marketing Cookies</h3>
          </div>
          <label class="cookie-toggle">
            <input type="checkbox" id="marketing-toggle" class="cookie-toggle__input" />
            <span class="cookie-toggle__slider"></span>
          </label>
        </div>
        <p class="cookie-modal__category-desc">
          These cookies may be used by our advertising partners to build a profile of your
          interests and show you relevant adverts on other sites.
        </p>
      </div>
    </div>

    <!-- Footer -->
    <div class="cookie-modal__footer">
      <button id="accept-all-settings-btn" class="cookie-modal__btn cookie-modal__btn--secondary">
        Accept All
      </button>
      <button id="save-settings-btn" class="cookie-modal__btn cookie-modal__btn--primary">
        Save Preferences
      </button>
    </div>
  </div>
</div>

<style lang="scss">
  @use '../styles/components/cookie-consent';
</style>

<script define:vars={{ CONSENT_KEY, CONSENT_VERSION, gdprConfig }}>
  // Cookie Consent Management
  class CookieConsent {
    constructor() {
      this.consentKey = CONSENT_KEY
      this.version = CONSENT_VERSION
      this.banner = document.getElementById('cookie-consent-banner')
      this.modal = document.getElementById('cookie-settings-modal')
      this.overlay = document.getElementById('cookie-consent-overlay')

      this.init()
    }

    init() {
      // Check if consent already given
      const consent = this.getConsent()

      if (!consent || consent.version !== this.version) {
        // Small delay to ensure smooth entrance animation
        setTimeout(() => this.showBanner(), 500)
      } else {
        this.applyConsent(consent)
      }

      this.attachEventListeners()
    }

    showBanner() {
      // Show overlay first
      if (this.overlay) {
        this.overlay.classList.add('is-visible')
        this.overlay.setAttribute('aria-hidden', 'false')
      }

      // Lock body scroll
      document.body.style.overflow = 'hidden'

      // Then show banner
      if (this.banner) {
        this.banner.classList.add('is-visible')
        this.banner.setAttribute('aria-hidden', 'false')
      }
    }

    hideBanner() {
      if (this.banner) {
        this.banner.classList.remove('is-visible')
        this.banner.setAttribute('aria-hidden', 'true')
      }

      // Hide overlay
      if (this.overlay) {
        this.overlay.classList.remove('is-visible')
        this.overlay.setAttribute('aria-hidden', 'true')
      }

      // Restore body scroll (only if modal is not open)
      if (!this.modal?.classList.contains('is-visible')) {
        document.body.style.overflow = ''
      }
    }

    showModal() {
      if (this.modal) {
        this.modal.classList.add('is-visible')
        this.modal.setAttribute('aria-hidden', 'false')

        // Ensure body scroll is locked (may already be locked by overlay)
        document.body.style.overflow = 'hidden'

        // Load current preferences
        const consent = this.getConsent()
        if (consent) {
          const analyticsToggle = document.getElementById('analytics-toggle')
          const marketingToggle = document.getElementById('marketing-toggle')
          if (analyticsToggle) analyticsToggle.checked = consent.analytics
          if (marketingToggle) marketingToggle.checked = consent.marketing
        }

        // Focus the first interactive element
        const closeButton = this.modal.querySelector('.cookie-modal__close')
        if (closeButton) {
          closeButton.focus()
        }
      }
    }

    hideModal() {
      if (this.modal) {
        this.modal.classList.remove('is-visible')
        this.modal.setAttribute('aria-hidden', 'true')

        // Only restore body scroll if overlay is also hidden
        // (consent has been given)
        if (!this.overlay?.classList.contains('is-visible')) {
          document.body.style.overflow = ''
        }
      }
    }

    getConsent() {
      try {
        const stored = localStorage.getItem(this.consentKey)
        return stored ? JSON.parse(stored) : null
      } catch (error) {
        return null
      }
    }

    saveConsent(preferences) {
      const consent = {
        necessary: true, // Always true
        analytics: preferences.analytics,
        marketing: preferences.marketing,
        timestamp: new Date().toISOString(),
        version: this.version,
      }

      try {
        localStorage.setItem(this.consentKey, JSON.stringify(consent))
        this.applyConsent(consent)
        this.hideBanner()
        this.hideModal()
      } catch (error) {
        console.error('Error saving consent:', error)
      }
    }

    applyConsent(consent) {
      // Apply consent preferences
      if (window.StratosTracker) {
        window.StratosTracker.consentGiven = consent.analytics
      }

      // Trigger custom event for other scripts
      window.dispatchEvent(new CustomEvent('cookieConsentUpdated', { detail: consent }))
    }

    acceptAll() {
      this.saveConsent({
        analytics: true,
        marketing: true,
      })
    }

    rejectAll() {
      this.saveConsent({
        analytics: false,
        marketing: false,
      })
    }

    saveSettings() {
      const analyticsToggle = document.getElementById('analytics-toggle')
      const marketingToggle = document.getElementById('marketing-toggle')

      this.saveConsent({
        analytics: analyticsToggle ? analyticsToggle.checked : false,
        marketing: marketingToggle ? marketingToggle.checked : false,
      })
    }

    attachEventListeners() {
      // Banner buttons
      document.getElementById('cookie-accept-btn')?.addEventListener('click', () => {
        this.acceptAll()
      })

      document.getElementById('cookie-reject-btn')?.addEventListener('click', () => {
        this.rejectAll()
      })

      document.getElementById('cookie-settings-btn')?.addEventListener('click', () => {
        this.showModal()
      })

      // Modal buttons
      document.getElementById('close-settings-modal')?.addEventListener('click', () => {
        this.hideModal()
      })

      document.getElementById('save-settings-btn')?.addEventListener('click', () => {
        this.saveSettings()
      })

      document.getElementById('accept-all-settings-btn')?.addEventListener('click', () => {
        this.acceptAll()
      })

      // Click outside modal to close
      const backdrop = this.modal?.querySelector('.cookie-modal__backdrop')
      backdrop?.addEventListener('click', () => {
        this.hideModal()
      })

      // Escape key to close modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.modal?.classList.contains('is-visible')) {
          this.hideModal()
        }
      })
    }
  }

  // Initialize cookie consent
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new CookieConsent()
    })
  } else {
    new CookieConsent()
  }
</script>
