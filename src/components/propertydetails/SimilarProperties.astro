---
// ========================================
// SIMILAR PROPERTIES COMPONENT
// Displays properties similar to the current one
// Server-side rendered for optimal performance
// ========================================

import { getSimilarProperties, type SimilarProperty } from '../../lib/api'

interface Props {
  propertyId: string
  listingType: string
  limit?: number
}

const { propertyId, listingType, limit = 4 } = Astro.props

// Normalize listing type for display logic
const isSale = listingType === 'sale' || listingType === 'for-sale'

// Helper to generate SEO-friendly property URL
function getPropertyUrl(property: SimilarProperty): string {
  if (property.url_slug) {
    return `/properties/${property.url_slug}`
  }

  const parts: string[] = []

  if (property.bedrooms === 0) {
    parts.push('studio')
  } else if (property.bedrooms && property.bedrooms > 0) {
    parts.push(`${property.bedrooms}-bed`)
  }

  if (property.property_type && property.property_type !== 'other') {
    parts.push(property.property_type.toLowerCase().replace(/\s+/g, '-'))
  }

  if (property.display_address) {
    const streetPart = property.display_address.split(',')[0]
      .replace(/^(flat|unit|apartment)\s*\d+[a-z]?\s*/i, '')
      .replace(/^\d+[a-z]?\s+/i, '')
    const locationSlug = streetPart
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .substring(0, 50)
    if (locationSlug) parts.push(locationSlug)
  }

  if (parts.length === 0) parts.push('property')

  return `/properties/${parts.join('-')}`
}

// Helper to format price
function formatPrice(property: SimilarProperty): string {
  const price = isSale ? property.asking_price : property.rent_amount
  if (!price) return 'POA'
  return `Â£${price.toLocaleString()}${!isSale ? ' pcm' : ''}`
}

// Fetch similar properties server-side
let properties: SimilarProperty[] = []
let modeDescription = ''

try {
  const result = await getSimilarProperties(propertyId, undefined, limit)
  if (result && result.properties) {
    properties = result.properties
    modeDescription = result.mode_description || ''
  }
} catch (err) {
  console.error('[SimilarProperties] Error fetching:', err)
}

const hasProperties = properties.length > 0
---

{hasProperties && (
  <section class="similar-section">
    <div class="similar-section__header">
      <h2 class="similar-section__title">Similar Properties</h2>
      <span class="similar-section__count">
        {properties.length}&nbsp;{properties.length === 1 ? 'property' : 'properties'}
      </span>
    </div>

    <!-- Property Cards Grid -->
    <div class="similar-section__grid">
      {properties.map((property) => (
        <a href={getPropertyUrl(property)} class="similar-card">
          <!-- Card Content (Above Image) -->
          <div class="similar-card__content">
            <!-- Title & Price Row -->
            <div class="similar-card__header">
              <h3 class="similar-card__title">{property.display_address}</h3>
              <span class="similar-card__price">{formatPrice(property)}</span>
            </div>

            <!-- Property Specs with Icons -->
            <div class="similar-card__specs">
              {Number(property.bedrooms) > 0 && (
                <span class="similar-card__spec">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 21V7a2 2 0 012-2h14a2 2 0 012 2v14"/>
                    <path d="M3 11h18"/>
                    <path d="M7 11V7"/>
                    <path d="M17 11V7"/>
                  </svg>
                  {property.bedrooms} Bed
                </span>
              )}
              {Number(property.bathrooms) > 0 && (
                <span class="similar-card__spec">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 12h16a1 1 0 011 1v3a4 4 0 01-4 4H7a4 4 0 01-4-4v-3a1 1 0 011-1z"/>
                    <path d="M6 12V5a2 2 0 012-2h1a2 2 0 012 2v2"/>
                  </svg>
                  {property.bathrooms} Bath
                </span>
              )}
              {(Number(property.floor_area) > 0 || Number(property.internal_area) > 0) && (
                <span class="similar-card__spec">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 9h18"/>
                    <path d="M9 21V9"/>
                  </svg>
                  {property.floor_area || property.internal_area} Sq
                </span>
              )}
            </div>
          </div>

          <!-- Card Image (Below Content) -->
          <div class="similar-card__image">
            {property.main_image_url ? (
              <img
                src={property.main_image_url}
                alt={property.display_address}
                loading="lazy"
              />
            ) : (
              <div class="similar-card__placeholder">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                  <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
              </div>
            )}

            {/* Featured badge */}
            {property.is_featured && (
              <span class="similar-card__badge similar-card__badge--featured">
                Featured
              </span>
            )}

            {/* Similarity score badge */}
            <span class="similar-card__badge similar-card__badge--match">
              {property.similarity_score}% match
            </span>
          </div>
        </a>
      ))}
    </div>
  </section>
)}

<style lang="scss">
  @use '../../styles/pages/property-details/similar';
</style>
